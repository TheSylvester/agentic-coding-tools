#!/usr/bin/env bash
# gemini-agent: Non-interactive Gemini CLI wrapper.
#
# Usage:
#   gemini-agent <prompt>                         # Args as prompt
#   gemini-agent --model <model> <prompt>         # Specify model
#   gemini-agent --resume <id> <prompt>           # Resume session
#   PROMPT_FILE=task.md gemini-agent              # Read from file
#   cat task.md | gemini-agent                    # Read from stdin
#
# Environment variables:
#   PROMPT_FILE          - Read prompt from this file
#   GEMINI_MODEL         - Model to use (passed as --model)
#   GEMINI_SESSION       - Session ID/index to resume

set -euo pipefail

MODEL="${GEMINI_MODEL:-}"
RESUME="${GEMINI_SESSION:-}"

# Parse flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    --model)
      MODEL="$2"
      shift 2
      ;;
    --resume|-r)
      RESUME="$2"
      shift 2
      ;;
    --)
      shift
      break
      ;;
    *)
      break
      ;;
  esac
done

# Determine prompt source: PROMPT_FILE > args > stdin
HAS_STDIN=false
[[ ! -t 0 ]] && HAS_STDIN=true

if [[ -n "${PROMPT_FILE:-}" ]]; then
  PROMPT="$(cat "$PROMPT_FILE")"
elif [[ $# -gt 0 ]]; then
  PROMPT="$*"
elif [[ "$HAS_STDIN" == "true" ]]; then
  PROMPT="$(cat || true)"
else
  echo "Usage: gemini-agent [--model <model>] <prompt>" >&2
  echo "       PROMPT_FILE=task.md gemini-agent" >&2
  echo "       cat task.md | gemini-agent" >&2
  exit 1
fi

# Validate prompt
if [[ -z "${PROMPT//[$' \t\r\n']/}" ]]; then
  echo "Error: prompt is empty" >&2
  exit 1
fi

# Verify gemini command exists
if ! command -v gemini >/dev/null 2>&1; then
  echo "Error: gemini command not found. Please install gemini CLI." >&2
  exit 1
fi

# Auto-detect auth: use GCA if OAuth creds exist and no explicit auth set
if [[ -z "${GEMINI_API_KEY:-}" && -z "${GOOGLE_GENAI_USE_VERTEXAI:-}" && -z "${GOOGLE_GENAI_USE_GCA:-}" ]]; then
  if [[ -s "${HOME}/.gemini/oauth_creds.json" ]]; then
    export GOOGLE_GENAI_USE_GCA=true
  fi
fi

# Build command args
GEMINI_ARGS=(-y --output-format json)
[[ -n "$MODEL" ]] && GEMINI_ARGS+=(--model "$MODEL")
[[ -n "$RESUME" ]] && GEMINI_ARGS+=(--resume "$RESUME")

# Run and capture output (stderr to /dev/null to avoid mixing with JSON)
OUTPUT=$(gemini "${GEMINI_ARGS[@]}" "$PROMPT" 2>/dev/null)

# Extract response and session_id from JSON (output is pretty-printed multi-line JSON)
if command -v jq >/dev/null 2>&1; then
  RESPONSE=$(echo "$OUTPUT" | jq -r '.response // empty' 2>/dev/null)
  SESSION_ID=$(echo "$OUTPUT" | jq -r '.session_id // empty' 2>/dev/null)
else
  # Fallback: basic extraction without jq
  RESPONSE=$(echo "$OUTPUT" | grep -oP '"response"\s*:\s*"\K[^"]*' | head -1)
  SESSION_ID=$(echo "$OUTPUT" | grep -oP '"session_id"\s*:\s*"\K[^"]*' | head -1)
fi

# Output response
if [[ -n "$RESPONSE" ]]; then
  echo "$RESPONSE"
else
  # If JSON parsing failed, output raw (minus stderr lines)
  echo "$OUTPUT" | grep -v "^YOLO mode\|^Loaded cached"
fi

# Always output session ID for caller to capture
if [[ -n "$SESSION_ID" ]]; then
  echo ""
  echo "[session_id: $SESSION_ID]"
fi
